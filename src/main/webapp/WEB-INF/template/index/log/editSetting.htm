<!DOCTYPE html>
[#include "../public/common.inc.htm"]
[#include "../public/resource.inc.htm"]
<table class="js-list-table"></table>
<div id="toolbar">
	<a href="javascript:void(0);" class="easyui-linkbutton js-control-search" iconcls="icon-search" plain="true">搜索</a>
	<a href="javascript:void(0);" class="easyui-linkbutton js-control-save" iconcls="icon-ok" plain="true">保存所选</a>
	<a href="javascript:void(0);" onclick="Web_redirectPage(-1);" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true">返回列表</a>
</div>
<script>
function formatter(key, value, row, index) {
	var html = '<input type="checkbox" name="' + key + '" value="1" data-id="' + row.id + '"'
			+ (row.log_setting && 1 == row.log_setting[key] ? ' checked="checked"' : '') + ' />';
	return html;
}
$(function () {
	$('.js-list-table').datagrid({
		url : '[@url action="listSetting" /]',
		pagination : true,
		idField : 'id',
		toolbar : '#toolbar',
		rownumbers : true,
		fitcolumns : true,
		fit : true,
		nowrap : true,
		singleSelect : true,
		checkOnSelect : false,
		selectOnCheck : false,
		columns:[[
			{field:'id',checkbox:true},
			{field:'show_id',title:'ID',formatter:function (value, row, index) {
				return row.id;
			}},
			{field:'name',title:'名称'},
			{field:'sort',title:'排序'},
			{field:'module',title:'模块'},
			{field:'controller',title:'控制器'},
			{field:'action',title:'方法'},
			{field:'refer_id',title:'引用'},
			{field:'enable',title:'启用',align:'center',formatter:function (value, row, index) {
				return formatter('enable', value, row, index);
			}},
			{field:'referer',title:'来源地址',align:'center',formatter:function (value, row, index) {
				return formatter('referer', value, row, index);
			}},
			{field:'request_url',title:'请求地址',align:'center',formatter:function (value, row, index) {
				return formatter('request_url', value, row, index);
			}},
			{field:'request_param',title:'请求参数',align:'center',formatter:function (value, row, index) {
				return formatter('request_param', value, row, index);
			}},
			{field:'session_id',title:'会话ID',align:'center',formatter:function (value, row, index) {
				return formatter('session_id', value, row, index);
			}},
			{field:'session_value',title:'会话值',align:'center',formatter:function (value, row, index) {
				return formatter('session_value', value, row, index);
			}},
			{field:'response_view',title:'响应视图',align:'center',formatter:function (value, row, index) {
				return formatter('response_view', value, row, index);
			}},
			{field:'response_data',title:'响应数据',align:'center',formatter:function (value, row, index) {
				return formatter('response_data', value, row, index);
			}},
			{field:'operate_id_text',title:'操作者'},
			{field:'operate_time',title:'操作时间',formatter:function (value, row, index) {
				return Web_formatDateTime(value);
			}}
		]],
		onLoadSuccess : function (data) {
			$('.js-list-button').linkbutton({
				plain : true
			});
			$('.js-list-table').datagrid('autoSizeColumn');
		}
	});
	
	$('.js-control-delete').bind('click', function () {
		var rows = $('.js-list-table').datagrid('getChecked');
		var ids = '', size = rows.length;
		if(size < 1) {
			Web_alertInfo('请选择要删除的记录！');
			return ;
		}
		for(var i = 0; i < size; i++) {
			var row = rows[i];
			ids += row.id;
			if(i + 1 < size) {
				ids += ',';
			}
		}
		var url = '[@url action="delete" /]?ids=' + ids;
		Web_redirectPage(url);
	});
});
</script>
<div id="js-search-dialog" style="width:230px;height:228px" data-options="buttons:'#js-search-button',modal:true,resizable:true">
<table align="center" class="table-horizontal tr-height25">
	<tr>
		<th>名称</th>
		<td><input class="easyui-textbox width150" type="text" name="name" value="" /></td>
	</tr>
	<tr>
		<th>模块</th>
		<td><input class="easyui-textbox width150" type="text" name="module" value="" /></td>
	</tr>
	<tr>
		<th>控制器</th>
		<td><input class="easyui-textbox width150" type="text" name="controller" value="" /></td>
	</tr>
	<tr>
		<th>方法</th>
		<td><input class="easyui-textbox width150" type="text" name="action" value="" /></td>
	</tr>
	<tr>
		<th>引用</th>
		<td><input class="easyui-numberspinner width150" type="text" name="referId" data-options="min:0" value="" /></td>
	</tr>
</table>
</div>
<div id="js-search-button">
	<a href="javascript:void(0);" class="easyui-linkbutton js-control-ok" data-options="iconCls:'icon-search'">搜索</a>
	<a href="javascript:void(0);" class="easyui-linkbutton js-control-cancel" data-options="iconCls:'icon-cancel'">取消</a>
</div>
<script>
$(function () {
	var $searchDialog = $('#js-search-dialog');
	$('.js-control-search').bind('click', function () {
		$searchDialog.dialog({
			title : '筛选条件',
			iconCls : 'icon-search',
			onOpen : function () {}
		});
	});
		
	$('#js-search-button').find('.js-control-ok').unbind('click.action').bind('click.action' ,function () {
		$('.js-list-table').datagrid('load', {
			name : $searchDialog.find('input[name="name"]').val(),
			module : $searchDialog.find('input[name="module"]').val(),
			controller : $searchDialog.find('input[name="controller"]').val(),
			action : $searchDialog.find('input[name="action"]').val(),
			referId : $searchDialog.find('input[name="referId"]').val()
		});
		$searchDialog.dialog('close');
	});
	$('#js-search-button').find('.js-control-cancel').unbind('click.action').bind('click.action' ,function () {
		$searchDialog.dialog('close');
	});
});
</script>
<div id="js-process-dialog" style="width:400px;height:250px" data-options="modal:true,resizable:true">
	<table class="easyui-datagrid js-process-list" data-options="toolbar:'#js-process-toolbar',rownumbers:true,fitcolumns:true">
	<thead>
		<tr>
			<th data-options="field:'id'">ID</th>
			<th data-options="field:'message'">结果</th>
		</tr>
	</thead>
	</table>
</div>
<div id="js-process-toolbar">
	<div class="easyui-progressbar js-process-bar" data-options="value:0" style="width:380px"></div>
</div>
<script>
$(function () {
	var $processDialog = $('#js-process-dialog');
	var $processList = $('.js-process-list');
	var $processBar = $('.js-process-bar');
	
	var bProcessing = false;
	function process(index, rows) {
		if(!bProcessing) return false;
		var length = rows.length;
		if(index >= length) return true;
		var row = rows[index];
		$.post('[@url action="saveSetting" /]', {
			id : row.id,
			enable : $('input[name="enable"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0,
			referer : $('input[name="referer"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0,
			request_url : $('input[name="request_url"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0,
			request_param : $('input[name="request_param"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0,
			session_id : $('input[name="session_id"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0,
			session_value : $('input[name="session_value"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0,
			response_view : $('input[name="response_view"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0,
			response_data : $('input[name="response_data"][data-id="' + row.id + '"]:checked').length > 0 ? 1 : 0
		}, function (data) {
			index++;
			$processList.datagrid('appendRow', {
				id : row.id,
				message : data.message
			});
			$processList.datagrid('autoSizeColumn');
			$processBar.progressbar('setValue', index / length * 100);
			process(index, rows);
		}, 'json');
	}
	
	$('.js-control-save').bind('click', function () {
		$processList.datagrid('loadData', []);
		$processBar.progressbar('setValue', 0);
		var rows = $('.js-list-table').datagrid('getChecked');
		if(rows.length < 1) {
			Web_alertInfo('请选择需要保存的记录');
			return false;
		}
		$processDialog.dialog({
			title : '保存进度',
			iconCls : 'icon-tip',
			onOpen : function () {
				bProcessing = true;
				process(0, rows);
			},
			onClose : function () {
				bProcessing = false;
				$('.js-list-table').datagrid('reload');
			}
		});
	});
});
</script>